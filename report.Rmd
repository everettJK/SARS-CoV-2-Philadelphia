---
fontsize: 12pt
geometry: margin=0.50in
subparagraph: yes
params: 
    title: "title"
    date:  "0000-00-00"
title: "`r params$title`"
date:  "`r params$date`"
header-includes:
   - \usepackage{pdflscape}
   - \newcommand{\blandscape}{\begin{landscape}}
   - \newcommand{\elandscape}{\end{landscape}}
   - \usepackage{pdfpages}
   - \usepackage{booktabs}
   - \usepackage{makecell}
   - \usepackage{float}
output:
  pdf_document:
    toc: false
    keep_tex: no
    latex_engine: xelatex
---

The table below provides a summary of subject samples for which sequencing data is available.  
The experiments column shows the number of sequencing experiments performed for each specimen.  
Experiment specific analyses are shown at the end of this report. The code base for this analysis 
can be found ([here](https://github.com/everettJK/SARS-CoV-2-Philadelphia)).

\vspace{0.5cm}

\small
Table 1. Sample summary.
\normalsize

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height=2}
library(ggplot2)
library(knitr)
library(kableExtra)
library(Biostrings)

# Order data list such that composite analyses are shown first.
dat <- dat[order(grepl('-', unlist(lapply(dat, '[[', 'seq_sample'))))]

# Add this to the VSP creation script.
dat <- lapply(dat, function(x){
         if(! 'variantTable' %in% names(x)) x$variantTable <- data.frame()
         if(! 'variantTableMajor' %in% names(x)) x$variantTableMajor <- data.frame()
         x
        })


# Convenience table for converting between VSP ids and human readable labels.
seqSample_to_label <- bind_rows(lapply(dat, function(x) tibble(seq_sample = x$seq_sample, label = paste0(x$sampleType, '\n', x$date))))


# Create a printabe reference genome name from the reference genome path.
refGenome <- sub('data/references/', '', sub( '.fasta', '', dat[[1]]$refGenomeFasta))

sampleTable <- bind_rows(lapply(dat, function(x){
  
  if(! 'contigs' %in% names(x)){
    x$contigs <- Biostrings::DNAStringSet()
    maxContigLength <- NA
  } else if (length(x$contigs) == 0){
    maxContigLength <- NA
  } else {
    maxContigLength = tryCatch({
      sprintf("%.2f", max(Biostrings::width(x$contigs))/1000)
    },  error = function(e) {
      NA
   })
  }
  
 if(length(x$inputGenomes) == 0) x$inputGenomes <- NA

 tibble(exp = x$seq_sample, type = ifelse(! grepl('-', x$seq_sample), 'composite', ' single experiment'), 
        genomes = x$inputGenomes, sampleType = x$sampleType, 
        sampleDate = x$date, largestContig = maxContigLength,
        percentRefReadCoverage   = ifelse(is.null(x$refGenomePercentCovered), NA, sprintf("%.1f%%", x$refGenomePercentCovered*100)), 
        percentRefReadCoverage5 = ifelse(is.null(x$refGenomePercentCovered_5reads), NA, sprintf("%.1f%%", x$refGenomePercentCovered_5reads*100))) 
}))

# Write a copy of the sample table to a file.
sampleTableOutput <- sampleTable
sampleTableOutput$Subject <- dat[[1]]$subject
sampleTableOutput <- sampleTableOutput[,c(9, 1:8)]
write.table(sampleTableOutput, sep = '\t', col.names = TRUE, row.names = FALSE, quote = FALSE,
            file = paste0('summaries/sampleSummaries/', dat[[1]]$subject, '.sampleSummary.tsv'))

names(sampleTable) <- c('Experiment', 'Type', 'Input genomes', 'Sample type', 'Sample date', 'Largest contig (KD)', 
                        'Reference read\ncoverage', 'Reference read\ncoverage (>= 5 reads)')

kable(sampleTable, 'latex', booktabs = T, linesep = '', align = 'c') %>% 
  column_spec(4, width = "2cm") %>% 
  column_spec(6, width = "3cm") %>% 
  column_spec(7, width = "3cm") %>%
  column_spec(8, width = "5cm") %>%
  kable_styling(latex_options="scale_down")
```

\newpage

### Variants shared across samples 

The heat map below shows how variants (reference genome `r refGenome`) are shared across subject samples 
where the percent variance is colored. Variants are called if a variant position is covered by 5 for more reads, 
the alternative base is found in > 50% of read pairs and the variant yields a PHRED score > 20. Gray tiles denote 
positions where the variant was not the major variant or no variants were found. The base composition of tiles are 
shown in the following plot.

\vspace{0.5cm}

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8.0, results='asis'}

varHeatMap <- function(x){
  
  # Determine which samples have variant tables and bind them into a single table.
  vt <- bind_rows(lapply(x, function(j){
          if('variantTableMajor' %in% names(j)){
            if(nrow(j$variantTableMajor) == 0) return(tibble())
    
            j$variantTableMajor$s <- paste0(j$variantTableMajor$POS, ' ', j$variantTableMajor$genes, '  ', j$variantTableMajor$type)
            j$variantTableMajor$seq_sample <- j$seq_sample
            dplyr::select(j$variantTableMajor, POS, s, seq_sample, QUAL, percentAlt)
          } else {
            return(tibble())
          }
        })) 
  
  if(nrow(vt) == 0) return(NA)

  # Cycle through all unique mutations found across the samples.
  vt2 <- bind_rows(lapply(split(vt, vt$s), function(mutation){
    
           # Cycle through all the samples with variant tables.
           bind_rows(lapply(unique(vt$seq_sample), function(sample){
             # Determine if the query variant was called for this sample at this position.
             
             # Does this postion in this sample have enough coverage to return a tile in the plot?
             # if(mutation$POS[1] == 21526) browser()
             if(! mutation$POS[1] %in% x[[sample]]$pileupData$V2){
               return(tibble())
             }
             
             # Is this mutation found in this samples variant table?
             o <- subset(vt, s == mutation$s[1] & seq_sample == sample)
             if(nrow(o) > 0){
               # Yes, the mutation was found in this sample and it was considered major (> 50%)
               return(o)
             } else {
               # This mutation was not found in this sample. Either WT, another mutation, 
               # or the same mutation which was not substantial enough to be considered major.
               # Return a data row with NA as a QUAL score which will create a gray tile.
               return(tibble(POS = mutation$POS[1], s = mutation$s[1], seq_sample = sample, QUAL = NA, percentAlt = NA))
             }
           }))
  })) %>% dplyr::arrange(POS) 
  
  vt2$s <- as.character(vt2$s)
  vt2$s <- sub('\\*', 'stop', vt2$s)
  vt2$s = factor(vt2$s, levels = rev(unique(vt2$s)))
  
  vt2$label <- seqSample_to_label[match(vt2$seq_sample, seqSample_to_label$seq_sample),]$label
  
  ggplot(vt2, aes(label, s, fill = percentAlt)) + 
  theme_bw() +
  scale_fill_gradient2(name = 'Occurrence', limits = c(0.50, 1), low = "red", mid = "gold2", high = "green4", 
                       midpoint = 0.75, na.value = 'gray90', breaks = c(0.5, 0.75, 1), labels = c('50%', '75%', '100%')) +
  geom_tile(color = 'black') +
  scale_x_discrete(position = "top") +
  labs(x = '', y = '') +
  theme(text = element_text(size=14), axis.text.x = element_text(angle = 90, hjust = 0.5))
} 


# Remove the component experiments if composite results are available.
seqSamples <- unname(unlist(lapply(dat, '[[', 'seq_sample')))
base_seqSamples <- sub('\\-\\S+$', '', seqSamples)
dat2 <- dat[!(base_seqSamples %in% seqSamples & grepl('\\-', seqSamples))]


v <- varHeatMap(dat2) 

if(length(v) == 1){
    cat('\n\n*No variants found*  \n\n')
} else {
    print(v)
}
```


\newpage

### Relative read abundances of variants

The plot below shows the relative abundances of bases read for each position in the previous variant heatmap 
where the total number of read pairs covering each position is printed on the stacked bar plots.

\vspace{0.5cm}

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8.5, fig.width=8, results='asis'}

positions <- unique(unlist(lapply(dat2, function(x) x$variantTableMajor$POS)))

if(length(positions) > 0){
  # Limit positions to variantTableMajor.
  d <- bind_rows(lapply(dat2, function(x){
         if(nrow(x$variantTable) > 0){
           x$variantTable <- subset(x$variantTable, POS %in% positions)
           x$variantTable$seq_sample <- x$seq_sample

           if(nrow(x$variantTable) > 0){
             x$variantTable$patient <- x$subject
             x$variantTable$sample  <- x$sampleType
             x$variantTable$date    <- x$date
             return(x$variantTable)
          } else {
            return(data.frame())
          }
         } else {
           return(data.frame())
         }
       } 
     ))

  # Metadata cleanup
  d$date <- sub('^4/', '04/', d$date)
  d$date <- sub('^3/', '03/', d$date)
  
  # Create 100% expected data entries for other samples where no variants were found.
  d <- bind_rows(lapply(split(d, paste(d$sample, d$date)), function(a){

       # Here we create a mock data frame of all positins we need to report.
       # We join V4 (read count) from the pileup data so that we can report the number of reads 
       # for a position if no variants were called for a position.
       m <- data.frame(CHROM = 'genome', POS = positions, REF = 'X', ALT = 'e', QUAL = 225, percentAlt = 1,
                       seq_sample = a$seq_sample[1], patient = a$patient[1], sample = a$sample[1], date = a$date[1]) %>%
            left_join(dplyr::select(dat2[[a$seq_sample[1]]]$pileupData, V2, V4), by = c('POS' = 'V2')) %>% 
            dplyr::rename(reads = V4)
       
       if(any(is.na(m$reads))) m[is.na(m$reads),]$reads <- 0 # Replace NAs with zeros.
       bind_rows(a, subset(m, POS %in% positions[! positions %in% a$POS]))
     }))

  # Rename select entries.  
  d$ALT <- sub('^e$', 'Expected', d$ALT)
  d$ALT <- sub('\\?', 'Ins/Del', d$ALT)
  if(any(grepl('del', d$ALT))) d[grepl('del', d$ALT),]$ALT <- 'Ins/Del'
  if(any(grepl('ins', d$ALT))) d[grepl('ins', d$ALT),]$ALT <- 'Ins/Del'

  d$ALT <- factor(d$ALT, levels = c('Expected', 'A', 'T', 'C', 'G', 'N', 'Ins/Del', 'No data'))
  
  if(any(d$reads == 0)) d[d$reads == 0,]$ALT <- 'No data'

  d$POS <- factor(d$POS, levels = unique(sort(d$POS)))
  
  labels <- group_by(d, POS, sample, date) %>% summarise(reads = reads[1]) %>% ungroup() 
  
  p <- ggplot(d, aes(POS, percentAlt, fill = ALT)) + 
       theme_bw() +
       scale_fill_manual(name = 'Base change', drop=FALSE, 
                         values = c('gray50', 'green3', 'red2', 'dodgerblue', 'gold2', 'purple', 'black', 'gray90')) +
       geom_col() +
       geom_text(data=labels, aes(POS, 1, label = reads), inherit.aes = FALSE, vjust=0.5, hjust=1.1, angle=90, size=5) +
       labs(x = 'Position', y = 'Percent reads') +
       scale_y_continuous(labels = scales::percent) +
       facet_wrap(sample~date, ncol = 1, strip.position = 'right') +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 12),
             axis.text.y = element_text(size = 12),
             axis.title=element_text(size=14),
             panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
             panel.background = element_blank(), axis.line = element_line(colour = "black"))
}

if(length(v) == 1){
    cat('\n\n*No variants found*  \n\n')
} else {
    print(p)
}
```

\newpage

## Analyses of individual experiments and composite results.  

```{r, echo=FALSE, message=FALSE, warning=FALSE,  results='asis', fig.width=8, fig.height=2}
sampleAnalysis <- function(dat){
  for (i in 1:length(dat)) {
    cat('\n### ',  paste0(dat[[i]]$seq_sample, ' | ', dat[[i]]$date, ' | ', dat[[i]]$sampleType, ' | ', dat[[i]]$sample_id, ' | ',
            ifelse(! grepl('-', dat[[i]]$seq_sample), '', paste0(dat[[i]]$inputGenomes, ' genomes | ')),
            ifelse(! grepl('-', dat[[i]]$seq_sample), 'composite result', 'single experiment'), '\n\n'))
  
    printPileUps <- FALSE
    if('pileupData' %in% names(dat[[i]])){
      if(nrow(dat[[i]]$pileupData) > 0){
        printPileUps <- TRUE
        pileup <-
          ggplot(dat[[i]]$pileupData, aes(V2, V4)) +
          theme_bw() +
          labs(x = 'Genome position', y = 'Reads') +
          geom_bar(stat = 'identity', width = 1, fill = 'gray50') +
          scale_x_continuous(expand = c(0, 0)) +
          geom_vline(xintercept = c(1, nchar(dat[[i]]$concensusSeq[1])), color = 'blue', linetype = 'dotted') +
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                panel.background = element_blank(), axis.line = element_line(colour = "black"),
                text = element_text(size=14), legend.position="none") 
     
       variantTableMajor <- data.frame()
       if('variantTableMajor' %in% names(dat[[i]])){  
         if(nrow(dat[[i]]$variantTableMajor) > 0){
           variantTableMajor <- dat[[i]]$variantTableMajor
           variantTableMajor$class <- variantTableMajor$type
           variantTableMajor$class <- ifelse(grepl('[A-Z]\\d+[A-Z]', variantTableMajor$class), 'missense', variantTableMajor$class)
           variantTableMajor$class <- ifelse(grepl('[A-Z]\\d+\\*', variantTableMajor$class), 'nonsense', variantTableMajor$class)
           variantTableMajor$class <- ifelse(grepl('ins|del', variantTableMajor$class), 'indel', variantTableMajor$class)
           variantTableMajor$class <- factor(variantTableMajor$class, levels = c(' ', 'silent', 'missense', 'nonsense', 'indel'))
           
           variantTableMajor$QUAL <- round(variantTableMajor$QUAL)
           pileup <- pileup + scale_fill_manual(name = 'variant', values =  c('gray50', 'green3', 'gold2', 'red2', 'black'), drop = FALSE) +
                     geom_point(data = variantTableMajor, shape = 21, aes(x = POS, y = -10, fill = class), size = 2)
         }
       }
      
      # Limit scale to 50 reads
      dat[[i]]$pileupData$V5 <- ifelse(dat[[i]]$pileupData$V4 > 50, 50, dat[[i]]$pileupData$V4)
   
      pileup2 <- 
        ggplot(dat[[i]]$pileupData, aes(V2, V5, fill = V4)) +
        theme_bw() +
        labs(x = 'Genome position', y = 'Reads\n') +
         geom_bar(stat = 'identity', width = 1, fill = 'gray50') +
         scale_x_continuous(expand = c(0, 0)) +
         geom_vline(xintercept = c(1, nchar(dat[[i]]$concensusSeq[1])), color = 'blue', linetype = 'dotted') +
         theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
               panel.background = element_blank(), axis.line = element_line(colour = "black"),
               text = element_text(size=14), legend.position="none")
 
      if(nrow(variantTableMajor) > 0 ){
        pileup2 <- pileup2 + scale_fill_manual(name = 'variant', values =  c('gray50', 'green3', 'gold2', 'red2', 'black'), drop = FALSE) +
                   geom_point(data = variantTableMajor, shape = 21, aes(x = POS, y = 0, fill = class), size = 2) +
                  theme(legend.position = "none")
      }  
     }
    }

    printContigs <- FALSE
    if('contigs' %in% names(dat[[i]])){
      if(length(dat[[i]]$contigs) > 0){
        contigs <- tibble(x1 = dat[[i]]$contigStartPos, 
                          x2 = width(dat[[i]]$contigs) + x1, 
                          y = names(dat[[i]]$contigs), 
                          w = width(dat[[i]]$contigs), 
                          e = dat[[i]]$contigsEditDists) %>%
                   dplyr::top_n(5, wt = w) %>% 
                   dplyr::slice(1:5) %>% 
                   dplyr::arrange(w) %>% 
                   mutate(y = factor(y, levels = unique(y)), y2 = paste(' ', as.character(1:n())))
     
        printContigs <- TRUE
        contigsPlot <- ggplot(contigs) +  
                       theme_bw()+
                       geom_segment(aes(x = x1, y = y2, xend = x2, yend = y2, color = e), size = 3) +
                       labs(x = 'Genome position', y = 'Contigs')+
                       scale_x_continuous(limits = c(1, max(contigs$x2)), expand = c(0, 0)) +
                       scale_color_gradient2(name = 'Edit dist.', low = "green4", mid = "gold2", high = "red", midpoint = 5) +
                       theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                             panel.background = element_blank(), axis.line = element_line(colour = "black"),
                             text = element_text(size=14),
                             legend.position = "bottom")
      }
    }
  
    if(printPileUps){   
      cat(paste0('The plot below shows the number of reads covering each nucleotide position in the reference genome. ', 
                 'Variants are shown as colored dots along the bottom of the plot and are color coded according by ',
                 'variant types: gray - transgenic, green - silent, gold - missense, red - nonsense, black - indel.',
                 '\n\n\\vspace{0.23cm}\n\n'))
      
      
   
      print(pileup)
      cat('\n\n\\vspace{0.35cm}\n\n')
      cat('\n\\vspace{0.25cm}\nExcerpt from plot above focusing on reads coverage from 0 to 50 NT.\n\n\\vspace{0.25cm}\n\n')
      print(pileup2)
      cat('\n\n\\vspace{0.50cm}\n\n')
    } else {
      cat('\n## No pileup data available.\n\n\\vspace{0.50cm}\n\n')
    }
  
    if(printContigs){
      cat(paste0('\n\\vspace{0.25cm}\nThe longest five assembled contigs are shown below colored by their edit distance to the reference ', 
                 'genome.\n\n\\vspace{0.25cm}\n\n'))
      print(contigsPlot)
    } else {
      cat('\n## No contig data available.\n\n\\vspace{0.50cm}\n\n')
    }
   
    cat('\\newpage\n')
  }

  cat('\\newpage\n')
}

sampleAnalysis(dat)
```


